# HAProxy configuration for VibeMQ cluster
#
# Load balances MQTT connections across cluster nodes with PROXY protocol v2.
# Uses round-robin balancing and HTTP health checks on metrics endpoint.

global
    log stdout format raw local0 info
    maxconn 4096

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5s
    timeout client 30s
    timeout server 30s

# Stats page at http://localhost:8404/stats
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s

# MQTT frontend
frontend mqtt_frontend
    bind *:1883
    default_backend mqtt_backend

# MQTT backend - load balance across cluster nodes
backend mqtt_backend
    balance roundrobin
    # Use HTTP health check on metrics port
    option httpchk GET /health
    # send-proxy-v2 preserves real client IP
    server-template vibemq 3 vibemq:1883 check port 9090 resolvers docker resolve-prefer ipv4 send-proxy-v2

# Docker DNS resolver
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold valid 5s
