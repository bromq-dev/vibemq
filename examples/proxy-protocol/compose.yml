# PROXY Protocol Example
#
# Demonstrates VibeMQ behind HAProxy with PROXY protocol enabled.
# HAProxy sends real client IP via PROXY protocol v2 headers.
#
# Usage:
#   docker compose up -d
#   mosquitto_pub -h localhost -p 1883 -t test -m "hello"
#   docker compose logs vibemq  # See real client IP in logs
#   docker compose down

configs:
  haproxy_cfg:
    file: ./haproxy.cfg
  vibemq_toml:
    file: ./vibemq.toml

services:
  haproxy:
    image: haproxy:3.3-alpine
    ports:
      - "1883:1883" # MQTT through proxy
      - "9001:9001" # WebSocket through proxy
      - "8404:8404" # HAProxy stats
    configs:
      - source: haproxy_cfg
        target: /usr/local/etc/haproxy/haproxy.cfg
    depends_on:
      - vibemq
    networks:
      - mqtt

  vibemq:
    image: ghcr.io/vibesrc/vibemq:latest
    build:
      context: ../..
      dockerfile: Dockerfile
    configs:
      - source: vibemq_toml
        target: /etc/vibemq/vibemq.toml
    command: ["-c", "/etc/vibemq/vibemq.toml"]
    networks:
      - mqtt
    # Internal ports - clients connect through HAProxy
    expose:
      - "1883"
      - "9001"
      - "9090"  # Metrics/health endpoint for HAProxy checks

networks:
  mqtt:
    driver: bridge
