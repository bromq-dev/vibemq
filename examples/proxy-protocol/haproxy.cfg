# HAProxy configuration for VibeMQ with PROXY protocol
#
# This config forwards MQTT and WebSocket connections to VibeMQ,
# sending the real client IP via PROXY protocol v2.

global
    log stdout format raw local0 info
    maxconn 4096

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5s
    timeout client 30s
    timeout server 30s

# Stats page at http://localhost:8404/stats
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s

# MQTT frontend (TCP)
frontend mqtt_frontend
    bind *:1883
    default_backend mqtt_backend

# MQTT backend with PROXY protocol v2
backend mqtt_backend
    balance roundrobin
    # Use HTTP health check on metrics port (avoids PROXY protocol noise)
    option httpchk GET /health
    # send-proxy-v2 sends real client IP to VibeMQ
    server vibemq1 vibemq:1883 check port 9090 send-proxy-v2

# WebSocket frontend (HTTP upgrade)
frontend ws_frontend
    bind *:9001
    mode http
    timeout client 300s
    default_backend ws_backend

# WebSocket backend with PROXY protocol v2
backend ws_backend
    mode http
    timeout server 300s
    # Use HTTP health check on metrics port (avoids PROXY protocol noise)
    option httpchk GET /health
    # send-proxy-v2 sends real client IP to VibeMQ
    server vibemq1 vibemq:9001 check port 9090 send-proxy-v2
